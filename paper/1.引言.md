# 1. 引言

## 课题背景

### 区块链概述
    2008年，Satoshi Nakamoto建立了第一个区块链系统——比特币，这是一种分布式的点对点系统，主要为了支持货币交易。
之后随着ETH的发展，智能合约给区块链带来了极大的技术变革，他帮助应用开发者极大地缩短了开发时间。
如今在不同领域，存在着各式各样的区块链系统，这些区块链的核心不是p2p通信方式或密码学加密/签名，而是区块链里的共识算法。

区块链是由一个共享的、容错的分布式数据库和多节点网络节点组成的。

    在区块链分布式数据库中，
数据通过共识算法以块的形式增加，不可以修改或者删除，防止被恶意篡改；
每个区块都至少会包含一个块的生成时间和签名，新增区块上会存储上一个区块的哈希值，以此与上一个区块相连；
所有的交易数据都会被双方签名，防止抵赖。

    在区块链多节点网络中，
所有节点都可以浏览所有区块；
所有节点都可以验证区块，参与共识算法，即可以通过共识算法增加区块。

    主要构成技术，
p2p技术，点对点传输，bt协议的支撑技术；
共识算法，是区块链能够保证不被篡改的核心，即保证数据是可信的；
椭圆加密算法，公钥私钥，数字签名等密码学算法；
默克尔树，区块链数据存储的数据结构。

    其实区块链本质上就是一种分布式数据库，一些分布式数据库的特性也适用于区块链，但由于区块链大部分是公链或联盟链的原因，
并且需要达到数据的强一致性和不可篡改的特性，区块链牺牲了很多分布式数据库的优点，当然也带来了一些分布式数据库没有的特性。

### 共识机制概述
    对于现实世界，共识就是一群人对一件或者多件事情达成一致的看法或者协议。在计算机世界中，我理解共识包含两个层面，
第一个层面是点的层面，即多个节点对某个数据达成一致共识；第二个层面是线的层面，即多个节点对多个数据的顺序达成一致共识。

    区块链本质上是一种去中心化的分布式数据库，用户登记和发行数字化资产、产权凭证、积分等，以点对点的方式进行转账、支付和交易。
由于网络原因，点对点网络总会存在延迟，并且众多网络节点中的每个节点所观察到的事务先后顺序不可能完全相同。
这种对特定时间段内事务的先后顺序达成共识的算法被称为共识机制。

    共识机制是区块链中的基础和重要组成部分，共识算法决定了参与节点通过某种协议对一些特定的数据达成一致。

    计算机科学领域早期的共识研究是分布式一致性，即在分布式系统中，如何保证系统中所有节点的数据完全相同并且可以对某些特定数据达成共识，
这也是分布式计算的基础。共识和一致性虽然有些细微的差别，共识侧重于系统中各个节点达成一致的过程，而一致性侧重于系统中各个节点最终达成的一种状态，
但在本文中共识和一致性不做区分，可以互换使用。

#### 传统分布式一致性算法
    早在1975年，Akkoyunlu、Ekanadham和Huber在论文（）中提出了著名的两军问题，证明了在不可靠的信道上试图达成一致是不可能。
后来影响整个互联网的TCP/IP协议的诞生也为解决两军问题提供了可行解。

    在1982年，Lamport、Shostak和Pease提出了拜占庭将军问题，研究在可能存在故障节点甚至是恶意节点的情况下，正常节点怎么对特定数据达成共识。
由于恶意节点的存在，即传递的信息可能是错误的，破坏系统的一致性，拜占庭将军问题也被认为是容错行问题中最难的类型之一。
拜占庭将军问题在区块链技术中具有重要地位，是区块链共识机制核心的基础，直接影响了区块链共识算法的设计和实现。

    在1988年，Brian和Barbara提出了VR一致性算法，采用主机-备份模式，它要求所有的数据操作都需要通过主机进行，然后复制到各个备份机来保持一致性。
    
    在1989年，Lamport在论文（）中提出了闻名的Paxos算法，该算法解决了分布式系统如何就某些特定数据达成共识，并且能容忍小于二分之一的故障节点，
但对于拜占庭将军问题也束手无策。后来的分布式一致性算法的研究，不管是在学术界还是在工业界，Paxos都有很深远的影响，
比如之后衍生出来的Classic Paxos、Byzantine Paxos等变种算法，还有在工业界Google用Paxos算法实现的GFS等。

    在2014年，Diego Ongaro在论文（）中提出了Raft算法，这是一个以易理解为首要设计原则设计的算法，
由于它比Paxos算法更容易理解和实现，这也是后来在工业界被广泛使用的重要原因之一。
    
    上面列举的这些分布式一致性算法主要用于分布式数据库，与目前主流的区块链共识算法相比，大多数都不考虑拜占庭将军问题，
即只考虑系统中出现故障节点，而不考虑恶意节点。

#### 主流区块链共识机制
    在1993年，Cynthia因为垃圾邮件的问题，首次提出了工作量证明， 它要求发送邮件的人必须做出一些特定的数学难题，
通过提高发邮件的成本来减少垃圾邮件。1999年，Markus正式提出了工作量证明的概念，这也为后来中本聪设计比特币的共识机制提供了基础。

    在1999年，Liskov等人提出了使用拜占庭容错算法，该算法的算法复杂度从BFT的指数级别降低到多项式级别，解决了BFT效率不高的问题，
从而使得拜占庭容错算法在工业界也变得可行，它可以容忍不超过三分之一的故障节点或者恶意节点。
    
    在2008年，中本聪发布的比特币白皮书，里面也提到了PoW的共识算法，该算法保证了比特币分布式记账的一致性。
    在2011年，Quantum在比特币论坛上首次提出了权益证明PoS共识算法
    在2013年，比特股项目提出了授权股份证明算法DPoS，
    在2016年，Miller等人提出了一个网络环境无关的拜占庭容错的分布式共识协议HoneyBaderBFt，这也是本课题实现的算法，
它与PBFT最大的区别是它能异步网络下很好的运行。

#### 共识机制的分类
    根据系统网络节点的不同，共识机制可以分成三大类：
（1）私链：私链即网络节点都是内部私有的，不允许外部节点加入，即不存在恶意节点。私链的共识算法一般都用于传统分布式数据库，
比如zookeeper的zab协议，就是类paxos算法的一种，只考虑系统中出现故障节点不考虑出现恶意节点。
（2）联盟链：联盟链中，最著名的就是Hyperledger组织下的Fabric项目，Fabric0.6版本使用的是pbft算法。对于联盟链，
每个新加入的节点都是需要验证和审核的。
（3）公链：与联盟链类似，公链也需要同时考虑网络中的故障节点和恶意节点，和联盟链最大的区别就是，
公链中的节点可以很自由的加入或者退出，不需要严格的验证和审核。

    现有常见的共识算法：
（1） 工作量证明：PoW是比特币中是用的共识算法，它需要矿工参与一场困难的周期性的数学竞赛，数学竞赛难以计算但是容易验证。
一旦某个矿工计算出了结果，他将这个结果和这段时间从网络中收集的交易信息一起打包，形成当前区块，并把这个区块广播到区块链中。
每个节点都可以验证这个结果是否正确，如果验证成功，节点会添加这个区块到自己的区块链数据库中。
（2） 股权证明：PoS采用的是一种伪随机的方式，根据每个账户持有Stake的多少来选择每一轮的出块人，持有的股票越多，概率越大。
与PoW类似，如果持有50%的股票才有攻击网络的能力。
（3） 容量证明：PoSpace类似与PoW，但是它要求大容量的硬盘空间，矿工通过向硬盘中写入指定大小的数据，来参与挖矿竞赛。
（4） 实用拜占庭容错：PBFT是一种拜占庭问题解决的方案，属于多数人共识的一种。PBFT每轮选择出块节点，
该节点生成的区块需要通过一系列表决的方式获得至少三分之二参与共识节点的同意。PBFT的优点是块的产生不需要其他节点验证，
也就是说不会出现其它节点不同意这个区块内交易信息的问题。因此，PBFT算法所有节点得出的区块即最终区块。但是，
PBFT也有一个很大的问题，就是这个算法的时间复杂度会随着加入节点的增大而大幅度增长，因此如果参与节点超过25个PBFT的效率将会很差。
（5）HoneyBadgerBFT：该算法是一个完全异步的共识算法，它不依赖与任何对于网络环境的假设。目前HoneyBadgerBFT协议仅支持封闭网络，
即在网络开始时系统中的节点数量是一定的，并且在运行过程中没有新的节点加入。

### 课题研究的目的和意义
    共识算法是区块链系统中最核心的组成部分之一，也是在当前区块链领域研究的热点方向。近年来共识算法的研究发展比较迅速，
HoneyBadgerBFT就是一个很好的例子，它相对于一些其它的拜占庭容错算法存在的问题进行改进：
（1）许多BFT网络依赖于时序假设来完成消息轮次。如果消息传递有困难，则选择并“调整”或更改超时参数。
这可能导致未优化的网络，缓慢的恢复时间以及涉及消息调度的攻击的漏洞。
（2）一些BFT协议（例如Nakamoto共识 - 通常称为工作证明）不会产生块终结性。换句话说，几个矿工可能同时开采区块，
导致临时的双链状态。这可能导致在验证事务之前等待很长时间，并且如果事务仅存在于短链上，则可以一起删除事务。
HBBFT协议提供即时块终结性。只有在网络中的验证节点完成事务之后才会生成块。如果验证器对块进行了签名，则即使它是最新的块也会完成。这可以防止短暂的分叉，并创建一个不可变的，即时的交易分类帐。
（3）工作证明区块链大量使用计算能力和浪费计算资源，而BFT协议可能会产生较慢的吞吐率和低效的数据传输。
（4）遇到网络攻击， HBBFT提供了几种防范攻击的功能：
即使网络受到胁迫，异步机制也允许传递消息。某些消息可以传递而其他消息可以延迟，但仍会取得进展。
一些加密交易达成协议交易内容仅在达成共识后才会显示，如果节点不知道消息中的内容，则无法抑制特定信息。
HoneyBadgerBFT则知道消息中的内容，这可以防止恶意节点选择性地阻止信息的审查攻击。
（5）不断发展的网络类型，如上所述，PBFT自1999年以来一直存在。由于网络发展迅速，未来的区块链网络可以包括移动电话，IOT设备和许多其他类型的节点。
这些网络以不同的速度运行，并且难以正确设置定时参数。像TOR这样的网络也提供额外的安全性，但在数据传输速度方面显然是落后的。
HBBFT解决了时间问题，因为没有时序参数，它是一种异步协议，其中事务可以在不同时间到达不同节点。我们对消息传递的唯一假设是最终消息将被送达。
    
    本课题通过对HoneyBadgetBFT实现，深入地了解HoneyBadgerBFT算法的实现原理和设计原则，以此为例，
从而对拜占庭容错的共识机制有更深层次的认识，这样在学习其它拜占庭容错的共识机制也会事半功倍。因为共识机制是区块链的灵魂，
未来区块链主要发展的技术重点，而区块链又是国家重点要发展的方向，通过对区块链共识机制的实现和测试可以更好地深入到区块链的核心部分，
，为之后剖析区块链的各个部分有很大的帮助。

### 项目需求
    本课题是实现一个拜占庭容错的共识算法HoneyBadgerBFT，通过模拟网络集群，实现多个节点的共识机制。为了把重点放在共识算法上，
实现HoneyBadgerBFT时简化了集群网络，使用的是进程间通信，也简化了事务结构体和验证事务的过程，
把实现的主要模块放在HondyBadger算法中的各个组成部分，如ACS、RBC、BBA等。整个算法大概分为三个步骤：
（1）每个节点从输入的事务中随机选择一批事务，并使用公钥加密，启动N个原子广播的实例（N为系统中节点个数），
在某一个原子广播完成以后将该广播对应的节点编号作为输入启动异步公共子集协议ACS。
（2）ACS协议在收集到足够多的节点发来的事务后终止，所有正常节点会达成一个关于事务子集的共识。
（3）解密达成共识的事务子集。
    
    从算法的大概步骤可以看出，HondyBadgerBFT的核心部分由两部分组成，分别是原子广播和异步公共子集协议ACS。
    课题的总体设计框图如下：
    
    各个部分分别实现的功能如下：
（1）HoneyBadger（HB）：从应用接收交易请求并且将请求放入缓存排队，HB还会管理通过epoch来区别每次共识。每次有一个新的epoch开始，HB都会在这次交易请求中带上一批事务，并传给ACS
（2）Asynchronous Common Set (ACS)：ACS用RBC和BBA来达成事务子集的共识
（3）Reliable Broadcast (RBC)：将单个节点的事务分发到网络中的其余节点。RBC的结果是网络中所有节点的事务的总和。RBC保证每个节点得到相同的输出，即使发送方或其他节点尝试向不同节点发送不同的信息。
（4）Byzantine Binary Agreement (BBA)：根据来自网络中所有节点的投票组合来确定该事务子集是否包含在事务集合中。一旦超过2/3的参与节点同意是否将事务子集包含在集合中，BBA就完成。
